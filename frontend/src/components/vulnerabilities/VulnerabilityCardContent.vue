<template>
	<div class="vulnerability-details">
		<n-scrollbar class="pr-2">
			<div class="flex flex-col gap-6">
				<!-- Basic Information -->
				<div class="section">
					<h3 class="section-title">Basic Information</h3>
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div class="detail-item">
							<label>CVE ID</label>
							<div class="value font-mono">{{ vulnerability.cve_id }}</div>
						</div>
						<div class="detail-item">
							<label>Severity</label>
							<Badge :color="getSeverityColor(vulnerability.severity)">
								<template #iconLeft><Icon :name="getSeverityIcon(vulnerability.severity)" :size="14" /></template>
								<template #value>{{ vulnerability.severity }}</template>
							</Badge>
						</div>
						<div class="detail-item">
							<label>Agent</label>
							<div class="value">{{ vulnerability.agent_name }}</div>
						</div>
						<div v-if="vulnerability.customer_code" class="detail-item">
							<label>Customer Code</label>
							<div class="value">{{ vulnerability.customer_code }}</div>
						</div>
					</div>
				</div>

				<!-- Description -->
				<div class="section">
					<h3 class="section-title">Description</h3>
					<div class="value">{{ vulnerability.title }}</div>
				</div>

				<!-- Package Information -->
				<div v-if="vulnerability.package_name" class="section">
					<h3 class="section-title">Package Information</h3>
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div class="detail-item">
							<label>Package Name</label>
							<div class="value font-mono">{{ vulnerability.package_name }}</div>
						</div>
						<div v-if="vulnerability.package_version" class="detail-item">
							<label>Version</label>
							<div class="value font-mono">{{ vulnerability.package_version }}</div>
						</div>
						<div v-if="vulnerability.package_architecture" class="detail-item">
							<label>Architecture</label>
							<div class="value">{{ vulnerability.package_architecture }}</div>
						</div>
					</div>
				</div>

				<!-- Scoring Information -->
				<div class="section">
					<h3 class="section-title">Scoring</h3>
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div v-if="vulnerability.base_score" class="detail-item">
							<label>CVSS Base Score</label>
							<Badge color="primary" type="splitted">
								<template #label>Score</template>
								<template #value>{{ vulnerability.base_score }}</template>
							</Badge>
						</div>
						<div v-if="vulnerability.epss_score" class="detail-item">
							<label>EPSS Score</label>
							<Badge color="warning" type="splitted">
								<template #label>Score</template>
								<template #value>{{ parseFloat(vulnerability.epss_score).toFixed(3) }}</template>
							</Badge>
						</div>
						<div v-if="vulnerability.epss_percentile" class="detail-item">
							<label>EPSS Percentile</label>
							<Badge color="warning" type="splitted">
								<template #label>Percentile</template>
								<template #value>{{ parseFloat(vulnerability.epss_percentile).toFixed(1) }}%</template>
							</Badge>
						</div>
					</div>
				</div>

				<!-- Timeline -->
				<div class="section">
					<h3 class="section-title">Timeline</h3>
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div class="detail-item">
							<label>Detected At</label>
							<div class="value">{{ formatDateTime(vulnerability.detected_at) }}</div>
						</div>
						<div v-if="vulnerability.published_at" class="detail-item">
							<label>Published At</label>
							<div class="value">{{ formatDateTime(vulnerability.published_at) }}</div>
						</div>
					</div>
				</div>

				<!-- References -->
				<div class="section">
					<h3 class="section-title">References</h3>
					<div class="value">
						<div v-if="vulnerability.references && parseReferences(vulnerability.references).length > 0">
							<div v-for="(ref, index) in parseReferences(vulnerability.references)" :key="index" class="mb-2">
								<a :href="ref" target="_blank" rel="noopener noreferrer" class="reference-link">
									{{ ref }}
								</a>
							</div>
						</div>
						<div v-else class="text-gray-500 dark:text-gray-400 italic">
							No references available
						</div>
					</div>
				</div>
			</div>
		</n-scrollbar>
	</div>
</template>

<script setup lang="ts">
import type { VulnerabilitySearchItem } from "@/types/vulnerabilities.d"
import { NScrollbar } from "naive-ui"
import Badge from "@/components/common/Badge.vue"
import Icon from "@/components/common/Icon.vue"
import { VulnerabilitySeverity } from "@/types/vulnerabilities.d"

const { vulnerability } = defineProps<{ vulnerability: VulnerabilitySearchItem }>()

function getSeverityIcon(severity: string): string {
	const iconMap: Record<string, string> = {
		[VulnerabilitySeverity.Critical]: "carbon:warning-filled",
		[VulnerabilitySeverity.High]: "carbon:warning",
		[VulnerabilitySeverity.Medium]: "carbon:warning-alt",
		[VulnerabilitySeverity.Low]: "carbon:information"
	}
	return iconMap[severity] || "carbon:help"
}

function getSeverityColor(severity: string): "primary" | "warning" | "success" | "danger" | undefined {
	const colorMap: Record<string, "primary" | "warning" | "success" | "danger"> = {
		[VulnerabilitySeverity.Critical]: "danger",
		[VulnerabilitySeverity.High]: "warning",
		[VulnerabilitySeverity.Medium]: "warning",
		[VulnerabilitySeverity.Low]: "primary"
	}
	return colorMap[severity]
}

function formatDateTime(dateString: string): string {
	return new Date(dateString).toLocaleString()
}

function parseReferences(references: string): string[] {
	if (!references || references.trim() === '') return []

	// Try to handle different formats:
	// 1. JSON array string
	try {
		const parsed = JSON.parse(references)
		if (Array.isArray(parsed)) {
			return parsed.filter(ref => ref && typeof ref === 'string' && ref.trim().length > 0)
		}
	} catch {
		// Not JSON, continue with other parsing methods
	}

	// 2. Comma, semicolon, or newline separated
	let refs = references.split(/[,;\n|]/).map(ref => ref.trim()).filter(ref => ref.length > 0)

	// 3. Space separated URLs (if they start with http)
	if (refs.length === 1 && refs[0].includes('http')) {
		const spaceRefs = refs[0].split(/\s+/).filter(ref => ref.startsWith('http'))
		if (spaceRefs.length > 1) {
			refs = spaceRefs
		}
	}

	return refs
}
</script>

<style scoped>
.vulnerability-details {
	max-height: 75vh;
	overflow-y: auto;
}

.section {
	border-bottom: 1px solid rgb(229 231 235);
	padding-bottom: 1rem;
	margin-bottom: 1rem;
}

.section:last-child {
	border-bottom: none;
	margin-bottom: 0;
}

.section-title {
	font-size: 1.125rem;
	font-weight: 600;
	margin-bottom: 0.75rem;
	color: rgb(17 24 39);
}

.detail-item {
	display: flex;
	flex-direction: column;
	gap: 0.25rem;
}

.detail-item label {
	font-size: 0.875rem;
	font-weight: 500;
	color: rgb(75 85 99);
}

.detail-item .value {
	font-size: 0.875rem;
	color: rgb(17 24 39);
}

.reference-link {
	color: rgb(37 99 235);
	text-decoration: underline;
	word-break: break-all;
}

.reference-link:hover {
	color: rgb(29 78 216);
}

/* Dark mode styles */
:deep(.dark) .section,
.dark .section {
	border-bottom-color: rgb(55 65 81);
}

:deep(.dark) .section-title,
.dark .section-title {
	color: rgb(243 244 246);
}

:deep(.dark) .detail-item label,
.dark .detail-item label {
	color: rgb(156 163 175);
}

:deep(.dark) .detail-item .value,
.dark .detail-item .value {
	color: rgb(243 244 246);
}

:deep(.dark) .reference-link,
.dark .reference-link {
	color: rgb(96 165 250);
}

:deep(.dark) .reference-link:hover,
.dark .reference-link:hover {
	color: rgb(147 197 253);
}

/* For better compatibility with different dark mode implementations */
@media (prefers-color-scheme: dark) {
	.section {
		border-bottom-color: rgb(55 65 81);
	}

	.section-title {
		color: rgb(243 244 246);
	}

	.detail-item label {
		color: rgb(156 163 175);
	}

	.detail-item .value {
		color: rgb(243 244 246);
	}

	.reference-link {
		color: rgb(96 165 250);
	}

	.reference-link:hover {
		color: rgb(147 197 253);
	}
}
</style>
