<template>
	<n-tabs type="line" animated :tabs-padding="24">
		<n-tab-pane name="Overview" tab="Overview" display-directive="show">
			<div class="flex flex-col gap-6 p-7 pt-2">
				<div class="grid-auto-fit-200 grid gap-2">
					<CardKV>
						<template #key>CVE ID</template>
						<template #value>
							{{ vulnerability.cve_id }}
						</template>
					</CardKV>
					<CardKV>
						<template #key>Severity</template>
						<template #value>
							<VulnerabilitySeverityBadge :severity="vulnerability.severity" />
						</template>
					</CardKV>
					<CardKV>
						<template #key>Title</template>
						<template #value>
							{{ vulnerability.title }}
						</template>
					</CardKV>
					<CardKV>
						<template #key>Agent</template>
						<template #value>
							{{ vulnerability.agent_name }}
						</template>
					</CardKV>
					<CardKV v-if="vulnerability.customer_code">
						<template #key>Customer</template>
						<template #value>
							<code
								class="text-primary cursor-pointer"
								@click.stop="gotoCustomer({ code: vulnerability.customer_code })"
							>
								#{{ vulnerability.customer_code }}
								<Icon :name="LinkIcon" :size="13" class="relative top-0.5" />
							</code>
						</template>
					</CardKV>
				</div>

				<n-card
					v-if="vulnerability.package_name"
					class="bg-secondary! overflow-hidden"
					title="Package Information"
				>
					<div class="flex flex-wrap justify-between gap-8">
						<n-statistic label="Package Name" :value="vulnerability.package_name" tabular-nums />
						<n-statistic label="Version" :value="vulnerability.package_version || '-'" tabular-nums />
						<n-statistic
							label="Architecture"
							:value="vulnerability.package_architecture || '-'"
							tabular-nums
						/>
					</div>
				</n-card>

				<n-card class="bg-secondary! overflow-hidden" title="Scoring">
					<div class="flex flex-wrap justify-between gap-8">
						<n-statistic label="CVSS Base Score" :value="`${vulnerability.base_score}`" tabular-nums />
						<n-statistic
							label="EPSS Score"
							:value="parseFloat(vulnerability.epss_score || '0').toFixed(3)"
							tabular-nums
						/>
						<n-statistic
							label="EPSS Percentile"
							:value="`${parseFloat(vulnerability.epss_percentile || '0').toFixed(1)}%`"
							tabular-nums
						/>
					</div>
				</n-card>
			</div>
		</n-tab-pane>
		<n-tab-pane name="Timeline" tab="Timeline" display-directive="show:lazy">
			<div class="p-7 pt-4">
				<n-timeline>
					<n-timeline-item
						v-if="vulnerability.published_at"
						type="success"
						title="Published at"
						:time="formatDateTime(vulnerability.published_at)"
					/>
					<n-timeline-item
						v-if="vulnerability.detected_at"
						title="Detected at"
						:time="formatDateTime(vulnerability.detected_at)"
						line-type="dashed"
					/>
				</n-timeline>
			</div>
		</n-tab-pane>
		<n-tab-pane name="References" tab="References" display-directive="show">
			<div class="p-7 pt-2">
				<ul v-if="vulnerability.references && parseReferences(vulnerability.references).length">
					<li v-for="refItem in parseReferences(vulnerability.references)" :key="refItem">
						<a :href="refItem" target="_blank">{{ refItem }}</a>
					</li>
				</ul>
				<n-empty v-else description="No references available" class="h-48 justify-center" />
			</div>
		</n-tab-pane>
	</n-tabs>
</template>

<script setup lang="ts">
import type { VulnerabilitySearchItem } from "@/types/vulnerabilities.d"
import { NCard, NEmpty, NStatistic, NTabPane, NTabs, NTimeline, NTimelineItem } from "naive-ui"
import CardKV from "@/components/common/cards/CardKV.vue"
import Icon from "@/components/common/Icon.vue"
import { useGoto } from "@/composables/useGoto"
import { useSettingsStore } from "@/stores/settings"
import { formatDate } from "@/utils"
import VulnerabilitySeverityBadge from "./VulnerabilitySeverityBadge.vue"

const { vulnerability } = defineProps<{ vulnerability: VulnerabilitySearchItem }>()

const dFormats = useSettingsStore().dateFormat

const { gotoCustomer } = useGoto()

const LinkIcon = "carbon:launch"

function parseReferences(references: string): string[] {
	if (!references || references.trim() === "") return []

	// Try to handle different formats:
	// 1. JSON array string
	try {
		const parsed = JSON.parse(references)
		if (Array.isArray(parsed)) {
			return parsed.filter(ref => ref && typeof ref === "string" && ref.trim().length > 0)
		}
	} catch {
		// Not JSON, continue with other parsing methods
	}

	// 2. Comma, semicolon, or newline separated
	let refs = references
		.split(/[,;\n|]/)
		.map(ref => ref.trim())
		.filter(ref => ref.length > 0)

	// 3. Space separated URLs (if they start with http)
	if (refs.length === 1 && refs[0].includes("http")) {
		const spaceRefs = refs[0].split(/\s+/).filter(ref => ref.startsWith("http"))
		if (spaceRefs.length > 1) {
			refs = spaceRefs
		}
	}

	return refs
}

function formatDateTime(timestamp: number | Date | string): string {
	return formatDate(timestamp, dFormats.datetimesec).toString()
}
</script>

<style scoped>
.section {
	border-bottom: 1px solid rgb(229 231 235);
	padding-bottom: 1rem;
	margin-bottom: 1rem;
}

.section:last-child {
	border-bottom: none;
	margin-bottom: 0;
}

.section-title {
	font-size: 1.125rem;
	font-weight: 600;
	margin-bottom: 0.75rem;
	color: rgb(17 24 39);
}

.detail-item {
	display: flex;
	flex-direction: column;
	gap: 0.25rem;
}

.detail-item label {
	font-size: 0.875rem;
	font-weight: 500;
	color: rgb(75 85 99);
}

.detail-item .value {
	font-size: 0.875rem;
	color: rgb(17 24 39);
}

.reference-link {
	color: rgb(37 99 235);
	text-decoration: underline;
	word-break: break-all;
}

.reference-link:hover {
	color: rgb(29 78 216);
}

/* Dark mode styles */
:deep(.dark) .section,
.dark .section {
	border-bottom-color: rgb(55 65 81);
}

:deep(.dark) .section-title,
.dark .section-title {
	color: rgb(243 244 246);
}

:deep(.dark) .detail-item label,
.dark .detail-item label {
	color: rgb(156 163 175);
}

:deep(.dark) .detail-item .value,
.dark .detail-item .value {
	color: rgb(243 244 246);
}

:deep(.dark) .reference-link,
.dark .reference-link {
	color: rgb(96 165 250);
}

:deep(.dark) .reference-link:hover,
.dark .reference-link:hover {
	color: rgb(147 197 253);
}

/* For better compatibility with different dark mode implementations */
@media (prefers-color-scheme: dark) {
	.section {
		border-bottom-color: rgb(55 65 81);
	}

	.section-title {
		color: rgb(243 244 246);
	}

	.detail-item label {
		color: rgb(156 163 175);
	}

	.detail-item .value {
		color: rgb(243 244 246);
	}

	.reference-link {
		color: rgb(96 165 250);
	}

	.reference-link:hover {
		color: rgb(147 197 253);
	}
}
</style>
