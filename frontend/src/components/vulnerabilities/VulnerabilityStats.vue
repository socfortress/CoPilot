<template>
	<n-spin :show="loading" content-class="flex flex-col gap-4">
		<!-- Statistics Cards -->
		<div>
			<div class="mb-5 flex flex-wrap items-center justify-between gap-3">
				<h3 class="flex items-center gap-2 text-lg font-semibold text-gray-900 dark:text-gray-100">
					<Icon name="carbon:chart-ring" :size="20" class="text-primary" />
					Distribution
				</h3>

				<p class="flex items-center gap-2 text-sm">
					Total:
					<code>{{ totalCount.toLocaleString() }}</code>
					<Icon :name="InfoIcon" :size="14" />
				</p>
			</div>

			<div class="grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-4">
				<n-card
					v-for="item of statisticsCards"
					:key="item.severity"
					class="ring-primary cursor-pointer transition-all duration-300 hover:ring-1"
					content-class="flex flex-col gap-2"
					size="small"
					@click="selectSeverity(item.severity)"
				>
					<div class="flex items-center justify-between gap-2 whitespace-nowrap">
						<div class="flex items-center gap-2">
							<VulnerabilitySeverityIcon :severity="item.severity" :size="24" :class="item.iconClass" />
							<span class="text-xl">{{ item.label }}</span>
						</div>
						<div class="font-mono text-xl font-bold">{{ stats[item.key].toLocaleString() }}</div>
					</div>
					<n-progress
						type="line"
						indicator-placement="inside"
						:percentage="getPercentage(stats[item.key])"
						:color="item.barColor"
						class="custom-progress"
					/>
				</n-card>
			</div>
		</div>

		<!-- Coverage Cards -->
		<div class="mt-8">
			<div class="mb-5 flex flex-wrap items-center justify-between gap-3">
				<h3 class="flex items-center gap-2 text-lg font-semibold text-gray-900 dark:text-gray-100">
					<Icon name="carbon:double-axis-chart-column" :size="20" class="text-primary" />
					Coverage
				</h3>

				<p class="flex items-center gap-2 text-sm">
					Coverage based on the 100 vulnerabilities with the highest EPSS score.
					<Icon :name="InfoIcon" :size="14" />
				</p>
			</div>

			<n-card class="bg-secondary! overflow-hidden">
				<div class="flex flex-wrap justify-between gap-8">
					<n-statistic label="Affected Agents" :value="stats.uniqueAgents.toLocaleString()" tabular-nums />
					<n-statistic label="Unique Packages" :value="stats.uniquePackages.toLocaleString()" tabular-nums />
					<n-statistic label="Customer Codes" :value="stats.uniqueCustomers.toLocaleString()" tabular-nums />
				</div>
			</n-card>
		</div>

		<!-- Top 5 Packages by EPSS Score -->
		<div v-if="topEpssPackages.length > 0" class="mt-8">
			<div class="mb-5 flex flex-wrap items-center justify-between gap-3">
				<h3 class="flex items-center gap-2 text-lg font-semibold">
					<Icon :name="PackageIcon" :size="20" class="text-primary" />
					Top 5 Packages by EPSS Score
				</h3>

				<p class="flex items-center gap-2 text-sm">
					Ranking based on the 100 vulnerabilities with the highest EPSS score.
					<Icon :name="InfoIcon" :size="14" />
				</p>
			</div>
			<div class="grid grid-cols-1 gap-10 md:grid-cols-3 lg:grid-cols-5">
				<div v-for="(pkg, index) in topEpssPackages" :key="pkg.package_name" class="flex items-stretch gap-2">
					<div class="flex items-end">
						<div
							class="w-4 rounded-md"
							:class="{
								'h-full bg-yellow-500': index === 0,
								'h-8/12 bg-gray-400': index === 1,
								'h-4/12 bg-amber-600': index === 2
							}"
						></div>
					</div>
					<div
						class="bg-secondary ring-primary flex grow cursor-pointer flex-col gap-2 rounded-md px-3 py-2 transition-all duration-300 hover:ring-1"
						@click="selectPackage(pkg.package_name)"
					>
						<div class="flex items-center gap-2 text-xl">
							<Icon
								:name="index < 3 ? 'carbon:trophy' : 'carbon:warning-alt'"
								:size="20"
								:class="
									index === 0
										? 'text-yellow-500'
										: index === 1
											? 'text-gray-400'
											: index === 2
												? 'text-amber-600'
												: 'text-info'
								"
							/>
							<span>#{{ index + 1 }}</span>
						</div>

						<div class="text-lg font-semibold leading-snug">{{ pkg.package_name }}</div>

						<div class="flex flex-col gap-1 break-all text-xs">
							<div class="flex items-center gap-2">
								<span>EPSS:</span>
								<span class="font-mono font-semibold">{{ pkg.maxEpssScore.toLocaleString() }}</span>
							</div>
							<div class="flex items-center gap-2">
								<span>Vulnerabilities:</span>
								<span class="font-mono font-semibold">{{ pkg.vulnCount.toLocaleString() }}</span>
							</div>
							<div class="flex items-center gap-2">
								<span>Affected Agents:</span>
								<span class="font-mono font-semibold">
									{{ pkg.affectedAgents.toLocaleString() }}
								</span>
							</div>
							<div class="flex items-center gap-2">
								<span>Max CVSS:</span>
								<span class="font-mono font-semibold">
									{{ pkg.maxCvssScore?.toFixed(1) || "N/A" }}
								</span>
							</div>
							<div class="flex items-center gap-2">
								<span>Critical count:</span>
								<span class="font-mono font-semibold">{{ pkg.criticalCount }}</span>
							</div>
							<div class="flex items-center gap-2">
								<span>High count:</span>
								<span class="font-mono font-semibold">{{ pkg.highCount }}</span>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</n-spin>
</template>

<script setup lang="ts">
import type { VulnerabilitiesListFilter } from "./types.d"
import type { VulnerabilitySearchItem, VulnerabilitySearchQuery } from "@/types/vulnerabilities.d"
import { watchDebounced } from "@vueuse/core"
import axios from "axios"
import _toNumber from "lodash/toNumber"
import { NCard, NProgress, NSpin, NStatistic, useMessage } from "naive-ui"
import { computed, ref, toRefs } from "vue"
import Api from "@/api"
import Icon from "@/components/common/Icon.vue"
import { VulnerabilitySeverity } from "@/types/vulnerabilities.d"
import VulnerabilitySeverityIcon from "./VulnerabilitySeverityIcon.vue"

const props = defineProps<{ filters: VulnerabilitiesListFilter[] }>()

const emit = defineEmits<{
	(e: "update:severity", value: VulnerabilitySeverity): void
	(e: "update:package", value: string): void
}>()

const { filters } = toRefs(props)

const message = useMessage()
const loading = ref(false)
const list = ref<VulnerabilitySearchItem[]>([])

// Severity counts from API response
const totalCount = ref(0)
const criticalCount = ref(0)
const highCount = ref(0)
const mediumCount = ref(0)
const lowCount = ref(0)

const PackageIcon = "carbon:package"
const InfoIcon = "carbon:information"

// Define the allowed keys for statistics
type SeverityKey = "critical" | "high" | "medium" | "low"

const statisticsCards: {
	label: string
	severity: VulnerabilitySeverity
	iconClass: string
	barColor: string
	key: SeverityKey
}[] = [
	{
		label: "Critical",
		severity: VulnerabilitySeverity.Critical,
		iconClass: "text-error",
		barColor: "var(--error-color)",
		key: "critical"
	},
	{
		label: "High",
		severity: VulnerabilitySeverity.High,
		iconClass: "text-orange-500",
		barColor: "var(--color-orange-500)",
		key: "high"
	},
	{
		label: "Medium",
		severity: VulnerabilitySeverity.Medium,
		iconClass: "text-warning",
		barColor: "var(--warning-color)",
		key: "medium"
	},
	{
		label: "Low",
		severity: VulnerabilitySeverity.Low,
		iconClass: "text-info",
		barColor: "var(--info-color)",
		key: "low"
	}
]

// Calculate statistics from current data
const stats = computed((): Record<SeverityKey | "uniqueAgents" | "uniquePackages" | "uniqueCustomers", number> => {
	// Use API response counts for global statistics across all pages
	const critical = criticalCount.value
	const high = highCount.value
	const medium = mediumCount.value
	const low = lowCount.value

	// Calculate unique values from current page data for context
	const uniqueAgents = new Set(list.value.map(v => v.agent_name)).size
	const uniquePackages = new Set(list.value.map(v => v.package_name).filter(Boolean)).size
	const uniqueCustomers = new Set(list.value.map(v => v.customer_code).filter(Boolean)).size

	return {
		critical,
		high,
		medium,
		low,
		uniqueAgents,
		uniquePackages,
		uniqueCustomers
	}
})

// Calculate top packages by EPSS score
const topEpssPackages = computed(() => {
	// Group vulnerabilities by package name
	const packageMap = new Map<
		string,
		{
			package_name: string
			vulnCount: number
			maxEpssScore: number
			maxCvssScore: number | null
			affectedAgents: Set<string>
			criticalCount: number
			highCount: number
		}
	>()

	list.value.forEach(vuln => {
		if (!vuln.package_name || !vuln.epss_score) return

		const epssScore = Number.parseFloat(vuln.epss_score)
		if (Number.isNaN(epssScore)) return

		const key = vuln.package_name
		const existing = packageMap.get(key)

		if (existing) {
			existing.vulnCount++
			existing.maxEpssScore = Math.max(existing.maxEpssScore, epssScore)
			if (vuln.base_score) {
				existing.maxCvssScore = Math.max(existing.maxCvssScore || 0, vuln.base_score)
			}
			existing.affectedAgents.add(vuln.agent_name)

			if (vuln.severity === VulnerabilitySeverity.Critical) existing.criticalCount++
			if (vuln.severity === VulnerabilitySeverity.High) existing.highCount++
		} else {
			packageMap.set(key, {
				package_name: vuln.package_name,
				vulnCount: 1,
				maxEpssScore: epssScore,
				maxCvssScore: vuln.base_score || null,
				affectedAgents: new Set([vuln.agent_name]),
				criticalCount: vuln.severity === VulnerabilitySeverity.Critical ? 1 : 0,
				highCount: vuln.severity === VulnerabilitySeverity.High ? 1 : 0
			})
		}
	})

	// Convert to array and sort by max EPSS score
	return Array.from(packageMap.values())
		.map(pkg => ({
			...pkg,
			affectedAgents: pkg.affectedAgents.size
		}))
		.sort((a, b) => b.maxEpssScore - a.maxEpssScore)
		.slice(0, 5)
})

function getPercentage(count: number): number {
	if (totalCount.value === 0) return 0
	return _toNumber(((count / totalCount.value) * 100).toFixed(1))
}

let abortController: AbortController | null = null

function getList() {
	abortController?.abort()
	abortController = new AbortController()

	loading.value = true

	const query: VulnerabilitySearchQuery = {
		page: 1,
		page_size: 100,
		customer_code: filters.value.find(o => o.type === "customer_code")?.value || undefined,
		severity: (filters.value.find(o => o.type === "severity")?.value as VulnerabilitySeverity) || undefined,
		cve_id: filters.value.find(o => o.type === "cve_id")?.value || undefined,
		agent_name: filters.value.find(o => o.type === "agent_name")?.value || undefined,
		package_name: filters.value.find(o => o.type === "package_name")?.value || undefined,
		include_epss: true
	}

	Api.vulnerabilities
		.searchVulnerabilities(query, abortController.signal)
		.then(res => {
			loading.value = false

			if (res.data.success) {
				list.value = res.data?.vulnerabilities || []

				// Store severity counts from API response
				totalCount.value = res.data?.total_count || 0
				criticalCount.value = res.data?.critical_count || 0
				highCount.value = res.data?.high_count || 0
				mediumCount.value = res.data?.medium_count || 0
				lowCount.value = res.data?.low_count || 0
			} else {
				message.warning(res.data?.message || "An error occurred. Please try again later.")
			}
		})
		.catch(err => {
			if (!axios.isCancel(err)) {
				message.error(err.response?.data?.message || "An error occurred. Please try again later.")
				loading.value = false
			}
		})
}

function selectSeverity(value: VulnerabilitySeverity) {
	emit("update:severity", value)
}

function selectPackage(value: string) {
	emit("update:package", value)
}

watchDebounced(
	filters,
	() => {
		getList()
	},
	{ deep: true, debounce: 300, immediate: true }
)
</script>

<style lang="scss" scoped>
.custom-progress {
	:deep() {
		.n-progress-graph-line-indicator {
			text-shadow:
				0px 0px 1px black,
				0px 0px 2px black,
				0px 0px 3px black;
			font-weight: bold;
			color: white !important;
		}
	}
}
</style>
