<template>
	<n-spin :show="loading" content-class="flex flex-col gap-4">
		<div>
			<div class="stat-card">
				<div class="stat-header">
					<Icon :name="TotalIcon" :size="20" class="text-blue-600" />
					<span class="stat-title">Total</span>
				</div>
				<div class="stat-value">{{ totalCount.toLocaleString() }}</div>
			</div>
		</div>
		<!-- Statistics Cards -->
		<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4">
			<div class="stat-card critical clickable" @click="selectSeverity(VulnerabilitySeverity.Critical)">
				<div class="stat-header">
					<Icon :name="CriticalIcon" :size="20" class="text-red-600" />
					<span class="stat-title">Critical</span>
				</div>
				<div class="stat-value">{{ stats.critical.toLocaleString() }}</div>
				<div class="stat-percentage">{{ getPercentage(stats.critical) }}%</div>
			</div>

			<div class="stat-card high clickable" @click="selectSeverity(VulnerabilitySeverity.High)">
				<div class="stat-header">
					<Icon :name="HighIcon" :size="20" class="text-orange-600" />
					<span class="stat-title">High</span>
				</div>
				<div class="stat-value">{{ stats.high.toLocaleString() }}</div>
				<div class="stat-percentage">{{ getPercentage(stats.high) }}%</div>
			</div>

			<div class="stat-card medium clickable" @click="selectSeverity(VulnerabilitySeverity.Medium)">
				<div class="stat-header">
					<Icon :name="MediumIcon" :size="20" class="text-yellow-600" />
					<span class="stat-title">Medium</span>
				</div>
				<div class="stat-value">{{ stats.medium.toLocaleString() }}</div>
				<div class="stat-percentage">{{ getPercentage(stats.medium) }}%</div>
			</div>

			<div class="stat-card low clickable" @click="selectSeverity(VulnerabilitySeverity.Low)">
				<div class="stat-header">
					<Icon :name="LowIcon" :size="20" class="text-blue-600" />
					<span class="stat-title">Low</span>
				</div>
				<div class="stat-value">{{ stats.low.toLocaleString() }}</div>
				<div class="stat-percentage">{{ getPercentage(stats.low) }}%</div>
			</div>
		</div>

		<!-- Top 5 Packages by EPSS Score -->
		<div v-if="topEpssPackages.length > 0" class="mb-4">
			<h3 class="mb-3 flex items-center gap-2 text-lg font-semibold text-gray-900 dark:text-gray-100">
				<Icon :name="PackageIcon" :size="20" class="text-orange-600" />
				Top 5 Packages by EPSS Score
			</h3>
			<div class="grid grid-cols-1 gap-4 lg:grid-cols-2 xl:grid-cols-3">
				<div
					v-for="(pkg, index) in topEpssPackages.slice(0, 5)"
					:key="`${pkg.package_name}-${pkg.maxEpssScore}`"
					class="epss-package-card clickable"
					:class="{
						'rank-1': index === 0,
						'rank-2': index === 1,
						'rank-3': index === 2
					}"
					@click="selectPackage(pkg.package_name)"
				>
					<div class="epss-header">
						<div class="epss-rank">
							<Icon
								:name="index < 3 ? 'carbon:trophy' : 'carbon:warning-alt'"
								:size="16"
								:class="
									index === 0
										? 'text-yellow-500'
										: index === 1
											? 'text-gray-400'
											: index === 2
												? 'text-amber-600'
												: 'text-orange-500'
								"
							/>
							<span class="rank-number">#{{ index + 1 }}</span>
						</div>
						<Badge color="warning" type="splitted" size="small">
							<template #label>EPSS</template>
							<template #value>{{ pkg.maxEpssScore.toFixed(3) }}</template>
						</Badge>
					</div>

					<div class="package-name">{{ pkg.package_name }}</div>

					<div class="package-stats">
						<div class="stat-row">
							<span class="stat-label">Vulnerabilities:</span>
							<span class="stat-value">{{ pkg.vulnCount.toLocaleString() }}</span>
						</div>
						<div class="stat-row">
							<span class="stat-label">Affected Agents:</span>
							<span class="stat-value">{{ pkg.affectedAgents.toLocaleString() }}</span>
						</div>
						<div class="stat-row">
							<span class="stat-label">Max CVSS:</span>
							<span class="stat-value">{{ pkg.maxCvssScore?.toFixed(1) || "N/A" }}</span>
						</div>
					</div>

					<!-- Critical/High severity indicator -->
					<div v-if="pkg.criticalCount > 0 || pkg.highCount > 0" class="severity-indicator">
						<Badge v-if="pkg.criticalCount > 0" color="danger" size="small">
							<template #value>{{ pkg.criticalCount }} Critical</template>
						</Badge>
						<Badge v-if="pkg.highCount > 0" color="warning" size="small">
							<template #value>{{ pkg.highCount }} High</template>
						</Badge>
					</div>
				</div>
			</div>
		</div>
	</n-spin>
</template>

<script setup lang="ts">
import type { VulnerabilitiesListFilter } from "./types.d"
import type { VulnerabilitySearchItem, VulnerabilitySearchQuery } from "@/types/vulnerabilities.d"
import { watchDebounced } from "@vueuse/core"
import axios from "axios"
import { NSpin, useMessage } from "naive-ui"
import { computed, ref, toRefs } from "vue"
import Api from "@/api"
import Icon from "@/components/common/Icon.vue"
import { VulnerabilitySeverity } from "@/types/vulnerabilities.d"

const props = defineProps<{ filters: VulnerabilitiesListFilter[] }>()

const emit = defineEmits<{
	(e: "update:severity", value: VulnerabilitySeverity): void
	(e: "update:package", value: string): void
}>()

const { filters } = toRefs(props)

const message = useMessage()
const loading = ref(false)
const list = ref<VulnerabilitySearchItem[]>([])

// Severity counts from API response
const totalCount = ref(0)
const criticalCount = ref(0)
const highCount = ref(0)
const mediumCount = ref(0)
const lowCount = ref(0)

const PackageIcon = "carbon:package"
const TotalIcon = "carbon:result"
const CriticalIcon = "carbon:warning-filled"
const HighIcon = "carbon:warning"
const MediumIcon = "carbon:warning-alt"
const LowIcon = "carbon:information"

// Calculate statistics from current data
const stats = computed(() => {
	// Use API response counts for global statistics across all pages
	const critical = criticalCount.value
	const high = highCount.value
	const medium = mediumCount.value
	const low = lowCount.value

	// Calculate unique values from current page data for context
	const uniqueAgents = new Set(list.value.map(v => v.agent_name)).size
	const uniquePackages = new Set(list.value.map(v => v.package_name).filter(Boolean)).size
	const uniqueCustomers = new Set(list.value.map(v => v.customer_code).filter(Boolean)).size

	return {
		critical,
		high,
		medium,
		low,
		uniqueAgents,
		uniquePackages,
		uniqueCustomers
	}
})

// Calculate top packages by EPSS score
const topEpssPackages = computed(() => {
	// Group vulnerabilities by package name
	const packageMap = new Map<
		string,
		{
			package_name: string
			vulnCount: number
			maxEpssScore: number
			maxCvssScore: number | null
			affectedAgents: Set<string>
			criticalCount: number
			highCount: number
		}
	>()

	list.value.forEach(vuln => {
		if (!vuln.package_name || !vuln.epss_score) return

		const epssScore = Number.parseFloat(vuln.epss_score)
		if (Number.isNaN(epssScore)) return

		const key = vuln.package_name
		const existing = packageMap.get(key)

		if (existing) {
			existing.vulnCount++
			existing.maxEpssScore = Math.max(existing.maxEpssScore, epssScore)
			if (vuln.base_score) {
				existing.maxCvssScore = Math.max(existing.maxCvssScore || 0, vuln.base_score)
			}
			existing.affectedAgents.add(vuln.agent_name)

			if (vuln.severity === VulnerabilitySeverity.Critical) existing.criticalCount++
			if (vuln.severity === VulnerabilitySeverity.High) existing.highCount++
		} else {
			packageMap.set(key, {
				package_name: vuln.package_name,
				vulnCount: 1,
				maxEpssScore: epssScore,
				maxCvssScore: vuln.base_score || null,
				affectedAgents: new Set([vuln.agent_name]),
				criticalCount: vuln.severity === VulnerabilitySeverity.Critical ? 1 : 0,
				highCount: vuln.severity === VulnerabilitySeverity.High ? 1 : 0
			})
		}
	})

	// Convert to array and sort by max EPSS score
	return Array.from(packageMap.values())
		.map(pkg => ({
			...pkg,
			affectedAgents: pkg.affectedAgents.size
		}))
		.sort((a, b) => b.maxEpssScore - a.maxEpssScore)
		.slice(0, 5)
})

function getPercentage(count: number): string {
	if (totalCount.value === 0) return "0"
	return ((count / totalCount.value) * 100).toFixed(1)
}

let abortController: AbortController | null = null

function getList() {
	abortController?.abort()
	abortController = new AbortController()

	loading.value = true

	const query: VulnerabilitySearchQuery = {
		page: 1,
		page_size: 100,
		customer_code: filters.value.find(o => o.type === "customer_code")?.value || undefined,
		severity: (filters.value.find(o => o.type === "severity")?.value as VulnerabilitySeverity) || undefined,
		cve_id: filters.value.find(o => o.type === "cve_id")?.value || undefined,
		agent_name: filters.value.find(o => o.type === "agent_name")?.value || undefined,
		package_name: filters.value.find(o => o.type === "package_name")?.value || undefined,
		include_epss: true
	}

	Api.vulnerabilities
		.searchVulnerabilities(query, abortController.signal)
		.then(res => {
			loading.value = false

			if (res.data.success) {
				list.value = res.data?.vulnerabilities || []

				// Store severity counts from API response
				totalCount.value = res.data?.total_count || 0
				criticalCount.value = res.data?.critical_count || 0
				highCount.value = res.data?.high_count || 0
				mediumCount.value = res.data?.medium_count || 0
				lowCount.value = res.data?.low_count || 0
			} else {
				message.warning(res.data?.message || "An error occurred. Please try again later.")
			}
		})
		.catch(err => {
			if (!axios.isCancel(err)) {
				message.error(err.response?.data?.message || "An error occurred. Please try again later.")
				loading.value = false
			}
		})
}

function selectSeverity(value: VulnerabilitySeverity) {
	emit("update:severity", value)
}

function selectPackage(value: string) {
	emit("update:package", value)
}

watchDebounced(
	filters,
	() => {
		getList()
	},
	{ deep: true, debounce: 300, immediate: true }
)
</script>
