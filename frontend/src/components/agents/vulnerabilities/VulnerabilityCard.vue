<template>
	<div class="vulnerability-card" :class="`severity-${vulnerability.severity}`" @click="showDialog = true">
		<div class="severity" :severity="vulnerability.severity">
			{{ vulnerability.severity }}
		</div>
		<div class="wrapper">
			<div class="title">
				<span>{{ title }}</span>
			</div>
			<div class="property">
				<div v-if="hideTooltip">
					<Icon :name="ClockIcon" />
					<span>{{ detectionTime }}</span>
				</div>
				<n-tooltip v-else placement="top-start">
					<span>Detection time</span>
					<template #trigger>
						<div>
							<Icon :name="ClockIcon" />
							<span>{{ detectionTime }}</span>
						</div>
					</template>
				</n-tooltip>
			</div>
			<div class="property">
				<div v-if="hideTooltip">
					<Icon :name="CounterIcon" />
					<span>{{ vulnerability.cve }}</span>
				</div>
				<n-tooltip v-else placement="top-start">
					<span>{{ `CVSS2: ${vulnerability.cvss2_score} - CVSS3: ${vulnerability.cvss3_score}` }}</span>
					<template #trigger>
						<div>
							<Icon :name="CounterIcon" />
							<span>{{ vulnerability.cve }}</span>
						</div>
					</template>
				</n-tooltip>
			</div>
			<div class="property">
				<div v-if="hideTooltip">
					<Icon :name="VulnerabilityIcon" />
					<span>{{ vulnerability.name }}</span>
				</div>
				<n-tooltip v-else placement="top-start">
					<span>{{ `Version: ${vulnerability.version}` }}</span>
					<template #trigger>
						<div>
							<Icon :name="VulnerabilityIcon" />
							<span>{{ vulnerability.name }}</span>
						</div>
					</template>
				</n-tooltip>
			</div>
		</div>

		<n-modal
			v-model:show="showDialog"
			preset="card"
			class="vulnerability-dialog"
			:title="extract"
			content-class="!p-0"
			style="width: 90vw; max-width: 1000px"
		>
			<n-tabs type="line" animated :tabs-padding="24">
				<n-tab-pane name="Details" tab="Details" display-directive="show">
					<div class="p-7 pt-4 pb-0">
						<CardKV>
							<template #key>title</template>
							<template #value>
								{{ vulnerability.title ?? "-" }}
							</template>
						</CardKV>
					</div>
					<div v-if="vulnerabilitySanitized" class="grid-auto-fit-200 grid gap-2 p-7 pt-2">
						<CardKV v-for="item of vulnerabilitySanitized" :key="item.label">
							<template #key>
								{{ item.label }}
							</template>
							<template #value>
								{{ item.value ?? "-" }}
							</template>
						</CardKV>
					</div>
				</n-tab-pane>
				<n-tab-pane name="External references" tab="External references" display-directive="show">
					<div class="p-7 pt-2">
						<ul>
							<li v-for="refItem of externalReferences" :key="refItem">
								<a :href="refItem" target="_blank">{{ refItem }}</a>
							</li>
						</ul>
					</div>
				</n-tab-pane>
				<n-tab-pane name="EPSS Score" tab="EPSS Score" display-directive="show:lazy">
					<div class="p-7 pt-2">
						<ThreatIntelEpssScore :cve="vulnerability.cve" />
					</div>
				</n-tab-pane>
			</n-tabs>
		</n-modal>
	</div>
</template>

<script setup lang="ts">
import type { AgentVulnerabilities } from "@/types/agents.d"
import { cloneDeep } from "lodash"
import _split from "lodash/split"
import _truncate from "lodash/truncate"
import { NModal, NTabPane, NTabs, NTooltip } from "naive-ui"
import { computed, defineAsyncComponent, ref, toRefs } from "vue"
import CardKV from "@/components/common/cards/CardKV.vue"
import Icon from "@/components/common/Icon.vue"
import { useSettingsStore } from "@/stores/settings"
import dayjs from "@/utils/dayjs"

const props = defineProps<{
	vulnerability: AgentVulnerabilities
	hideTooltip?: boolean
}>()

const ThreatIntelEpssScore = defineAsyncComponent(() => import("@/components/threatIntel/ThreatIntelEpssScore.vue"))

const { vulnerability, hideTooltip } = toRefs(props)

const ClockIcon = "carbon:time"
const CounterIcon = "mdi:counter"
const VulnerabilityIcon = "bi:radioactive"
const dFormats = useSettingsStore().dateFormat

const title = computed(() => _truncate(vulnerability.value.title, { length: 20 }))
const extract = computed(() => _truncate(vulnerability.value.title, { length: 50 }))
const externalReferences = computed(() =>
	(vulnerability.value.external_references || []).map(ref => _split(ref, ",")).flat()
)

const vulnerabilitySanitized = computed(() => {
	const newObj = []
	const obj = cloneDeep(vulnerability.value)
	for (const k in obj) {
		const prop = obj[k as keyof typeof obj]
		if (typeof prop === "string") {
			const maybeTime = dayjs(prop as string | number | Date | null | undefined)
			if (maybeTime.isValid()) {
				// @ts-expect-error k is ok
				obj[k] = maybeTime.format(dFormats.datetime)
			}
		}

		if (!["external_references", "id", "title"].includes(k)) {
			newObj.push({
				label: k,
				// @ts-expect-error k is ok
				value: obj[k]
			})
		}
	}
	return newObj
})

const detectionTime = computed(() => {
	const detection_time = dayjs(vulnerability.value.detection_time)
	if (!detection_time.isValid()) return vulnerability.value.detection_time

	return detection_time.format(dFormats.datetime)
})

const showDialog = ref(false)
</script>

<style lang="scss" scoped>
.vulnerability-card {
	overflow: visible;
	border: 2px solid var(--bg-body-color);
	background-color: var(--bg-default-color);
	max-width: 100%;
	box-sizing: border-box;
	transition: all 0.3s;
	cursor: pointer;
	position: relative;
	border-radius: var(--border-radius);
	padding-block: calc(var(--spacing) * 2);

	.severity {
		position: absolute;
		top: -10px;
		right: -2px;
		border: 2px solid var(--bg-body-color);
		border-radius: var(--border-radius);
		line-height: 1;
		text-transform: uppercase;
		font-family: var(--font-family-mono);
		padding-inline: calc(var(--spacing) * 2);
		padding-block: calc(var(--spacing) * 0.5);
		font-size: var(--text-xs);
		white-space: nowrap;
		text-overflow: ellipsis;
		background-color: var(--bg-default-color);
		transition: all 0.3s;

		&::before {
			content: "";
			position: absolute;
			right: 0;
			bottom: -2px;
			z-index: 1;
			width: calc(100% + 2px);
			height: 13px;
			background-color: var(--bg-default-color);
			transition: all 0.3s;
		}
		&::after {
			content: attr(severity);
			position: absolute;
			top: 0;
			right: 0px;
			text-align: center;
			padding-inline: calc(var(--spacing) * 2);
			padding-block: calc(var(--spacing) * 0.5);
			font-size: var(--text-xs);
			z-index: 2;
			width: 100%;
			height: 100%;
		}
	}

	.wrapper {
		padding-inline: calc(var(--spacing) * 4);
		padding-block: calc(var(--spacing) * 3);

		.title {
			font-weight: bold;
			line-height: 1.2;
			margin-bottom: 10px;
		}

		.property {
			font-size: 13px;
			margin-bottom: 2px;

			& > div {
				display: flex;
				align-items: center;
				gap: 6px;
			}
		}
	}

	&.severity-Critical {
		border-color: var(--error-color);
		.severity {
			color: var(--error-color);
			border-color: var(--error-color);
		}
	}
	&.severity-High {
		border-color: var(--error-color);
		.severity {
			color: var(--error-color);
			border-color: var(--error-color);
		}
	}
	&.severity-Low {
	}
	&.severity-Medium {
		border-color: var(--warning-color);
		.severity {
			color: var(--warning-color);
			border-color: var(--warning-color);
		}
	}
	&.severity-Untriaged {
	}
}
</style>
